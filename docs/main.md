# Микросервис Main

Микросервис Main отвечает за управление продуктами (позициями меню) и избранными товарами в системе пиццерии. Он предоставляет API для получения информации о продуктах из меню и управления списком избранного.

## База данных

Сервис использует PostgreSQL для хранения данных о продуктах и избранных товарах. Основные таблицы:

### Таблица `menu_positions`

| Поле | Тип | Описание |
|------|-----|-----------|
| id | Integer | Уникальный идентификатор продукта (первичный ключ) |
| name | String(32) | Название продукта |
| cost | Numeric(12,6) | Цена продукта с точностью до 6 знаков |
| type | String(32) | Тип продукта: пицца, закуска, напиток |
| preview_link | String(32) | Ссылка на изображение продукта |
| description | String(256) | Описание продукта |
| characteristics | JSONB | Характеристики продукта (БЖУ, калории) |
| ingredients | JSONB | Ингредиенты продукта |
| additions | JSONB | Дополнительные ингредиенты |

### Таблица `favorites_products`

| Поле | Тип | Описание |
|------|-----|-----------|
| id | Integer | Уникальный идентификатор записи (первичный ключ) |
| product_id | Integer | Идентификатор продукта из меню |
| product_info | JSONB | Полная информация о продукте на момент добавления в избранное |

## API Endpoints

### 1. Управление продуктами

#### 1.1. Получение всех продуктов

**Endpoint:** `GET /api/main/get_products`

Возвращает список всех продуктов из меню.

##### Ответы:

**Успех (200 OK):**
```json
{
  "products": [
    {
      "id": 1,
      "name": "Пепперони",
      "cost": 19.99,
      "type": "pizza",
      "preview_link": "/pepperoni.png",
      "description": "Острая пицца с пепперони",
      "characteristics": {
        "calories": 280,
        "protein": 12,
        "fat": 10,
        "carbs": 32
      },
      "ingredients": ["тесто", "томатный соус", "пепперони", "сыр"],
      "additions": ["острый соус", "оливки"]
    }
  ],
  "count": 1
}
```

**Ошибки:**
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.2. Получение продукта по ID

**Endpoint:** `GET /api/main/get_product/<int:product_id>`

Возвращает информацию о конкретном продукте по его идентификатору.

##### Параметры URL:

- `product_id` (обязательный) - идентификатор продукта

##### Ответы:

**Успех (200 OK):**
```json
{
  "product": {
    "id": 1,
    "name": "Пепперони",
    "cost": 19.99,
    "type": "pizza",
    "preview_link": "/pepperoni.png",
    "description": "Острая пицца с пепперони",
    "characteristics": {
      "calories": 280,
      "protein": 12,
      "fat": 10,
      "carbs": 32
    },
    "ingredients": ["тесто", "томатный соус", "пепперони", "сыр"],
    "additions": ["острый соус", "оливки"]
  }
}
```

**Ошибки:**
- `404 Not Found` - продукт не найден
- `500 Internal Server Error` - внутренняя ошибка сервера

### 2. Управление избранными товарами

#### 2.1. Добавление товара в избранное

**Endpoint:** `POST /api/main/favorite`

Добавляет товар в список избранных.

##### Тело запроса (JSON):

```json
{
  "product_id": 123
}
```

##### Параметры:

- `product_id` (обязательный) - идентификатор товара

##### Ответы:

**Успех (201 Created):**
```json
{
  "success": "Favorite product created"
}
```

**Товар уже в избранном (208 Already Reported):**
```json
{
  "success": "Favorite product already created"
}
```

**Ошибки:**
- `400 Bad Request` - неверные данные запроса
- `404 Not Found` - товар не существует
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 2.2. Удаление товара из избранного

**Endpoint:** `DELETE /api/main/favorite`

Удаляет товар из списка избранных.

##### Тело запроса (JSON):

```json
{
  "product_id": 123
}
```

##### Параметры:

- `product_id` (обязательный) - идентификатор товара

##### Ответы:

**Успех (200 OK):**
```json
{
  "success": "Favorite product deleted"
}
```

**Ошибки:**
- `400 Bad Request` - неверные данные запроса
- `404 Not Found` - товар не найден в избранном
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 2.3. Получение списка избранных товаров

**Endpoint:** `GET /api/main/get_favorites`

Возвращает список всех избранных товаров.

##### Ответы:

**Успех (200 OK):**
```json
[
  {
    "id": 1,
    "product_id": 1,
    "product_info": {
      "id": 1,
      "name": "Сырная",
      "cost": 0.067683,
      "type": "pizza",
      "preview_link": "/cheese.avif",
      "description": "Моцарелла, сыры чеддер и пармезан, фирменный соус альфредо",
      "characteristics": {
        "calories": 250,
        "protein": 12,
        "fat": 8,
        "carbohydrates": 35
      },
      "ingredients": [
        "фирменный соус альфредо",
        "моцарелла",
        "сыры чеддер",
        "пармезан"
      ],
      "additions": [
        "сырный бортик",
        "острый перец",
        "чесночный соус"
      ]
    }
  }
]
```

**Ошибки:**
- `500 Internal Server Error` - внутренняя ошибка сервера

### 3. Health Check

**Endpoint:** `GET /api/main/health`

Проверка работоспособности сервиса.

#### Ответ:

```
OK
```

Статус: 200 OK

## Особенности реализации

### Кэширование
- Список продуктов кэшируется в Redis на 6 часов по умолчанию
- Отдельные продукты также кэшируются по ключу `cache:product:{product_id}`
- При запросе продуктов сначала проверяется кэш, затем база данных
- В ответе указывается флаг `cached` для отладки

### Избранные товары
- При добавлении в избранное сохраняется полная информация о продукте
- Это гарантирует, что изменения в основном меню не повлияют на уже добавленные в избранное товары
- Проверяется существование продукта перед добавлением в избранное

## Обработка ошибок

Сервис возвращает стандартные HTTP статусы и JSON-ответы с описанием ошибки:

```json
{
  "error": "Описание ошибки"
}
```

## Логирование

Сервис использует структурированное JSON-логирование с включением:
- временных меток
- уровня логирования
- информации о запросе (IP, метод, путь)
- контекстной информации сервиса
- трассировки stack trace для ошибок

## Зависимости

- PostgreSQL 16 - база данных для продуктов и избранного
- Redis - база данных для кэширования
- Flask - веб-фреймворк
- SQLAlchemy - ORM
- Redis-py - клиент Redis

## Переменные окружения

- `MAIN_POSTGRES_USER` - пользователь PostgreSQL
- `MAIN_POSTGRES_PASSWORD` - пароль PostgreSQL  
- `MAIN_POSTGRES_DB` - имя базы данных
- `MAIN_DATABASE_URL` - хост базы данных
- `CACHE_REDIS_URL` - БД для кэширования продуктов
- `PRODUCTS_CACHE_TTL` - время жизни кэша