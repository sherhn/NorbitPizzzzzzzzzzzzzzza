# Микросервис Orders

Микросервис Orders отвечает за обработку заказов и управление корзиной в системе пиццерии. Он предоставляет API для создания новых заказов и управления корзиной товаров.

## База данных

Сервис использует PostgreSQL для хранения данных о заказах и Redis для хранения корзины. Основные таблицы:

### Таблица `user_orders`

| Поле | Тип | Описание |
|------|-----|-----------|
| id | Integer | Уникальный идентификатор заказа (первичный ключ) |
| order_time | DateTime | Время создания заказа |
| payment_sum | Numeric(12,6) | Итоговая сумма заказа с точностью до 6 знаков |
| payment_currency | String(32) | Валюта оплаты (по умолчанию 'LTC') |
| positions | JSONB | Список позиций в заказе с полной информацией |
| address | JSONB | Адрес доставки |
| paid | Boolean | Статус оплаты |

## API Endpoints

### 1. Управление корзиной

#### 1.1. Добавление товара в корзину

**Endpoint:** `POST /api/orders/cart`

Добавляет товар в корзину или увеличивает количество на 1, если товар уже есть в корзине.

##### Тело запроса (JSON):

```json
{
  "product_id": 123
}
```

##### Параметры:

- `product_id` (обязательный) - идентификатор товара

##### Ответы:

**Успех (200 OK):**
```json
{"success": "Product added to cart"}
```
или
```json
{"success": "Product quantity increased in cart"}
```

**Ошибки:**
- `400 Bad Request` - отсутствует product_id или JSON данные
- `404 Not Found` - товар не существует
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.2. Удаление товара из корзины

**Endpoint:** `DELETE /api/orders/cart/<product_id>`

Полностью удаляет товар из корзины.

##### Параметры пути:

- `product_id` (обязательный) - идентификатор товара

##### Ответы:

**Успех (200 OK):**
```json
{"success": "Product removed from cart"}
```

**Ошибки:**
- `404 Not Found` - товар не найден в корзине
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.3. Уменьшение количества товара в корзине

**Endpoint:** `POST /api/orders/cart/<product_id>/decrement`

Уменьшает количество товара в корзине на 1. Если количество становится 0, товар удаляется из корзины.

##### Параметры пути:

- `product_id` (обязательный) - идентификатор товара

##### Ответы:

**Успех (200 OK):**
```json
{"success": "Product quantity decreased in cart"}
```
или
```json
{"success": "Product removed from cart (quantity was 1)"}
```

**Ошибки:**
- `404 Not Found` - товар не найден в корзине
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.4. Переключение дополнения для товара

**Endpoint:** `POST /api/orders/cart/<product_id>/toggle_addition`

Включает/выключает конкретное дополнение для товара в корзине.

##### Тело запроса (JSON):

```json
{
  "addition_name": "сырный бортик"
}
```

##### Параметры:

- `product_id` (обязательный) - идентификатор товара в пути
- `addition_name` (обязательный) - название дополнения для переключения

##### Ответы:

**Успех (200 OK):**
```json
{
  "success": "Addition \"сырный бортик\" toggled",
  "addition_name": "сырный бортик",
  "new_state": true,
  "product_id": 1
}
```

**Ошибки:**
- `400 Bad Request` - отсутствует addition_name или JSON данные, или дополнение не доступно для товара
- `404 Not Found` - товар не найден в корзине
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.5. Получение содержимого корзины

**Endpoint:** `GET /api/orders/cart`

Возвращает все товары в корзине с общей суммой и количеством позиций.

##### Ответы:

**Успех (200 OK):**
```json
{
  "cart": [
    {
      "product_id": 1,
      "quantity": 2,
      "product_info": {
        "id": 1,
        "name": "Сырная",
        "type": "pizza",
        "cost": 0.067683,
        "description": "Моцарелла, сыры чеддер и пармезан, фирменный соус альфредо",
        "image_url": "/cheese.avif",
        "ingredients": ["фирменный соус альфредо", "моцарелла", "сыры чеддер", "пармезан"],
        "characteristics": {
          "calories": 250,
          "protein": 12,
          "fat": 8,
          "carbohydrates": 35
        },
        "additions": {
          "сырный бортик": true,
          "острый перец": false,
          "чесночный соус": false
        }
      }
    }
  ],
  "total": 0.135366,
  "count": 1
}
```

**Ошибки:**
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.6. Очистка корзины

**Endpoint:** `DELETE /api/orders/cart`

Полностью очищает корзину.

##### Ответы:

**Успех (200 OK):**
```json
{"success": "Cart cleared"}
```

**Ошибки:**
- `500 Internal Server Error` - внутренняя ошибка сервера

### 2. Создание заказа

**Endpoint:** `POST /api/orders/make_order`

Создает новый заказ в системе на основе текущей корзины.

#### Тело запроса (JSON):

```json
{
  "address": {
    "street": "ул. Примерная, д. 1",
    "city": "Москва",
    "zip_code": "123456",
    "apartment": "25"
  },
  "payment_currency": "LTC"
}
```

#### Параметры:

- `address` (обязательный) - объект с адресом доставки
- `payment_currency` (опционально) - валюта оплаты (по умолчанию 'LTC')

#### Ответы:

**Успех (201 Created):**
```json
{
  "message": "Order created successfully",
  "data": {
    "order_id": 1,
    "order_time": "2025-11-27T08:09:15.903292",
    "payment_sum": 0.135366,
    "payment_currency": "LTC",
    "paid": true,
    "positions_count": 1,
    "positions": [
      {
        "product_id": 1,
        "name": "Сырная",
        "type": "pizza",
        "price": 0.067683,
        "quantity": 2,
        "total": 0.135366,
        "additions": ["сырный бортик"],
        "image_url": "/cheese.avif",
        "description": "Моцарелла, сыры чеддер и пармезан, фирменный соус альфредо"
      }
    ]
  }
}
```

**Ошибки:**
- `400 Bad Request` - корзина пуста или отсутствует адрес
- `500 Internal Server Error` - внутренняя ошибка сервера

### 3. Health Check

**Endpoint:** `GET /api/orders/health`

Проверка работоспособности сервиса.

#### Ответ:

```
OK
```

Статус: 200 OK

## Особенности реализации

### Корзина
- Корзина хранится в Redis с TTL 48 часов по умолчанию
- Ключ корзины: `cart:default_user`
- При любых изменениях корзины TTL обновляется
- Дополнения товаров сохраняются как словарь {название: активность}

### Обработка заказов
- При создании заказа корзина автоматически очищается
- Позиции заказа содержат полную информацию о товарах
- Активные дополнения сохраняются в массиве `additions` каждой позиции
- Суммы рассчитываются с точностью до 6 знаков после запятой

## Обработка ошибок

Сервис возвращает стандартные HTTP статусы и JSON-ответы с описанием ошибки:

```json
{
  "error": "Описание ошибки"
}
```

## Логирование

Сервис использует структурированное JSON-логирование с включением:
- временных меток
- уровня логирования
- информации о запросе (IP, метод, путь)
- контекстной информации сервиса
- трассировки stack trace для ошибок

## Зависимости

- PostgreSQL 16 - база данных для заказов
- Redis - база данных для корзины
- Flask - веб-фреймворк
- SQLAlchemy - ORM
- Redis-py - клиент Redis

## Переменные окружения

- `ORDERS_POSTGRES_USER` - пользователь PostgreSQL
- `ORDERS_POSTGRES_PASSWORD` - пароль PostgreSQL  
- `ORDERS_POSTGRES_DB` - имя базы данных
- `ORDERS_DATABASE_URL` - хост базы данных
- `REDIS_URL` - БД для корзины
- `MAIN_SERVICE_URI` - хост основного сервиса
- `CART_TTL_SECONDS` - время жизни корзины