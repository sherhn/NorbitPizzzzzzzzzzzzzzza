# Микросервис Orders

Микросервис Orders отвечает за обработку заказов и управление корзиной в системе пиццерии. Он предоставляет API для создания новых заказов и управления корзиной товаров.

## База данных

Сервис использует PostgreSQL для хранения данных о заказах и Redis для хранения корзины. Основные таблицы:

### Таблица `user_orders`

| Поле | Тип | Описание |
|------|-----|-----------|
| id | Integer | Уникальный идентификатор заказа (первичный ключ) |
| order_time | DateTime | Время создания заказа |
| payment_sum | Double | Итоговая сумма заказа |
| payment_currency | String(32) | Валюта оплаты (по умолчанию 'LTC') |
| positions | JSONB | Список позиций в заказе |
| additions | JSONB | Дополнения к позициям |
| address | JSONB | Адрес доставки |
| paid | Boolean | Статус оплаты |

## API Endpoints

### 1. Управление корзиной

#### 1.1. Добавление товара в корзину

**Endpoint:** `POST /api/orders/cart`

Добавляет товар в корзину или увеличивает количество на 1, если товар уже есть в корзине.

##### Тело запроса (JSON):

```json
{
  "product_id": 123
}
```

##### Параметры:

- `product_id` (обязательный) - идентификатор товара

##### Ответы:

**Успех (200 OK):**
```json
{"success": "Product added to cart"}
```
или
```json
{"success": "Product quantity increased in cart"}
```

**Ошибки:**
- `400 Bad Request` - отсутствует product_id или JSON данные
- `404 Not Found` - товар не существует
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.2. Удаление товара из корзины

**Endpoint:** `DELETE /api/orders/cart/<product_id>`

Полностью удаляет товар из корзины.

##### Параметры пути:

- `product_id` (обязательный) - идентификатор товара

##### Ответы:

**Успех (200 OK):**
```json
{"success": "Product removed from cart"}
```

**Ошибки:**
- `404 Not Found` - товар не найден в корзине
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.3. Получение содержимого корзины

**Endpoint:** `GET /api/orders/cart`

Возвращает все товары в корзине с общей суммой.

##### Ответы:

**Успех (200 OK):**
```json
[
    {
        "id": 1,
        "product_id": 1,
        "product_info": {
            "additions": [
                "сырный бортик",
                "острый перец",
                "чесночный соус"
            ],
            "characteristics": {
                "calories": 250,
                "carbohydrates": 35,
                "fat": 8,
                "protein": 12
            },
            "cost": 0.067683,
            "description": "Моцарелла, сыры чеддер и пармезан, фирменный соус альфредо",
            "id": 1,
            "ingredients": [
                "фирменный соус альфредо",
                "моцарелла",
                "сыры чеддер",
                "пармезан"
            ],
            "name": "Сырная",
            "preview_link": "/cheese.avif",
            "type": "pizza"
        }
    }
]
```

**Ошибки:**
- `500 Internal Server Error` - внутренняя ошибка сервера

#### 1.4. Очистка корзины

**Endpoint:** `DELETE /api/orders/cart`

Полностью очищает корзину.

##### Ответы:

**Успех (200 OK):**
```json
{"success": "Cart cleared"}
```

**Ошибки:**
- `500 Internal Server Error` - внутренняя ошибка сервера

### 2. Создание заказа

**Endpoint:** `POST /api/orders/make_order`

Создает новый заказ в системе.

#### Тело запроса (JSON):

```json
{
    "address": {
        "street": "ул. Примерная, д. 1",
        "city": "Москва", 
        "zip_code": "123456",
        "apartment": "25"
    },
    "payment_currency": "LTC",  // опционально, по умолчанию "LTC"
    "additions": ["Без лука", "Срочно"]  // опционально, по умолчанию []
}
```

#### Параметры:

- `payment_currency` (опционально) - валюта оплаты (по умолчанию 'LTC')
- `additions` (опционально) - массив объектов с дополнениями
- `address` (обязательный) - объект с адресом доставки

#### Ответы:

**Успех (201 Created):**
```json
{
    "data": {
        "order_id": 1,
        "order_time": "2025-11-27T08:09:15.903292",
        "paid": true,
        "payment_currency": "LTC",
        "payment_sum": 0.11130200000000001,
        "positions_count": 2
    },
    "message": "Order created successfully"
}
```

**Ошибки:**
- `400 Bad Request` - неверные данные запроса
- `500 Internal Server Error` - внутренняя ошибка сервера

### 3. Health Check

**Endpoint:** `GET /api/orders/health`

Проверка работоспособности сервиса.

#### Ответ:

```
OK
```

Статус: 200 OK

## Обработка ошибок

Сервис возвращает стандартные HTTP статусы и JSON-ответы с описанием ошибки:

```json
{
  "error": "Описание ошибки"
}
```

## Логирование

Сервис использует структурированное JSON-логирование с включением:
- временных меток
- уровня логирования
- информации о запросе (IP, метод, путь)
- контекстной информации сервиса

## Зависимости

- PostgreSQL 16 - база данных для заказов
- Redis - база данных для корзины
- Flask - веб-фреймворк
- SQLAlchemy - ORM

## Переменные окружения

- `ORDERS_POSTGRES_USER` - пользователь PostgreSQL
- `ORDERS_POSTGRES_PASSWORD` - пароль PostgreSQL  
- `ORDERS_POSTGRES_DB` - имя базы данных
- `ORDERS_DATABASE_URL` - хост базы данных
- `REDIS_URL` - БД для корзины
- `MAIN_SERVICE_URI` - хост основного сервиса
- `CART_TTL_SECONDS` - время жизни корзины