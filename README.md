# Документация проекта "Пиццерия"

## Обзор проекта

Проект представляет собой микросервисную архитектуру для системы заказов пиццы, состоящую из двух основных сервисов и вспомогательных компонентов.

## Технологический стек

### Бекенд
- **Python 3.x** - основной язык разработки
- **Flask** - веб-фреймворк для API
- **SQLAlchemy** - ORM для работы с базами данных
- **PostgreSQL 16** - реляционная база данных
- **Redis** - кэширование и хранение временных данных
- **Docker** - контейнеризация приложений

### Фронтенд
- **Нативный JavaScript** (ES6+) - без фреймворков
- **HTML5/Tailwind** - разметка и стили
- **Nginx** - веб-сервер и прокси

### Инфраструктура
- **Docker Compose** - оркестрация контейнеров
- **PostgreSQL 16** - базы данных
- **Redis 7** - кэш и сессии
- **PgAdmin 4** - веб-интерфейс для управления БД

## Архитектура микросервисов

### 1. Микросервис Main (`pizza_main`)
**Назначение:** Управление продуктами и избранными товарами

**Порты:** 5000

**База данных:** `db_main` (PostgreSQL)

**Основные функции:**
- Управление меню продуктов (пиццы, закуски, напитки)
- Работа с избранными товарами
- Кэширование данных о продуктах
- Отслеживание популярных товаров

**Ключевые эндпоинты:**
- `GET /api/main/get_products` - получение всего меню
- `GET /api/main/get_product/{id}` - получение конкретного продукта
- `POST/DELETE /api/main/favorite` - управление избранным
- `GET /api/main/get_favorites` - список избранного
- `POST /api/main/make_recent` - обновление популярности
- `GET /api/main/get_recent` - популярные товары

### 2. Микросервис Orders (`pizza_orders`)
**Назначение:** Управление корзиной и обработка заказов

**Порты:** 5001

**База данных:** `db_orders` (PostgreSQL)

**Основные функции:**
- Управление корзиной покупок
- Обработка заказов
- Управление дополнениями к товарам
- Расчет итоговых сумм

**Ключевые эндпоинты:**
- `POST /api/orders/cart` - добавление в корзину
- `DELETE /api/orders/cart/{id}` - удаление из корзины
- `GET /api/orders/cart` - просмотр корзины
- `POST /api/orders/make_order` - создание заказа
- `POST /api/orders/cart/{id}/toggle_addition` - управление дополнениями

## Взаимодействие компонентов

### Схема данных
```
Фронтенд (JS) → Nginx → Микросервисы → Базы данных
                    ↓           ↓
                 Redis (кэш)  Redis (корзина)
```

### Поток заказа
1. **Пользователь** выбирает город через `cities.js`
2. **Просмотр меню** через `menu.js` (запросы к Main сервису)
3. **Добавление в корзину** через `cart.js` (запросы к Orders сервису)
4. **Управление избранным** через `favorites.js` (запросы к Main сервису)
5. **Оформление заказа** через `cart.js` (создание заказа в Orders сервису)
6. **Обновление популярности** (Orders → Main через `/make_recent`)

### Взаимодействие микросервисов
- **Orders → Main**: При создании заказа отправляется запрос на обновление счетчиков популярности
- **Кэширование**: Оба сервиса используют Redis для кэширования данных
- **Согласованность**: Каждый сервис работает со своей БД, обеспечивая слабую связность

## Структура данных

### Main Service
```sql
menu_positions (id, name, cost, type, preview_link, description, characteristics, ingredients, additions)
favorites_products (id, product_id, product_info)
```

### Orders Service
```sql
user_orders (id, order_time, payment_sum, payment_currency, positions, address, paid)
```

### Redis
- `cache:products` - кэш всего меню (TTL: 6 часов)
- `cache:product:{id}` - кэш отдельных продуктов
- `cart:default_user` - корзина пользователя (TTL: 48 часов)
- `recent_products:score` - счетчики популярности товаров

## Особенности реализации

### Безопасность
- Валидация входных данных на всех эндпоинтах
- Проверка существования товаров перед операциями
- Обработка ошибок с соответствующими HTTP статусами

### Производительность
- Многоуровневое кэширование в Redis
- Оптимизированные запросы к БД
- TTL для временных данных
- Пагинация и лимиты для больших списков

### Масштабируемость
- Микросервисная архитектура
- Раздельные базы данных
- Статуeless дизайн
- Контейнеризация

## Развертывание

### Требования
- Docker и Docker Compose
- Доступ к портам 80 (веб), 5000-5001 (API), 8080 (pgAdmin)

### Переменные окружения
```env
# Базы данных
MAIN_POSTGRES_USER, MAIN_POSTGRES_PASSWORD, MAIN_POSTGRES_DB
ORDERS_POSTGRES_USER, ORDERS_POSTGRES_PASSWORD, ORDERS_POSTGRES_DB

# Redis
REDIS_URL, CACHE_REDIS_URL

# TTL настройки
PRODUCTS_CACHE_TTL, RECENT_PRODUCTS_CACHE_TTL, CART_TTL_SECONDS

# Сервисы
MAIN_SERVICE_URI, ORDERS_DATABASE_URL, MAIN_DATABASE_URL
```

### Запуск
```bash
# Полная пересборка
./build/rebuild.ps1

# Пересборка отдельных образов
./build/rebuild_image.ps1 -s "web"
```

## Мониторинг и логирование

### Логирование
- Структурированные JSON логи
- Включение контекста запросов
- Раздельные логи для разных сервисов
- Уровни логирования: INFO, WARNING, ERROR

### Health Checks
- Эндпоинты `/health` в каждом микросервисе
- Автоматические проверки в Docker Compose
- Мониторинг состояния БД и Redis

## API Документация

Полная документация по API доступна в отдельных файлах:
- `main.md` - документация Main сервиса
- `orders.md` - документация Orders сервиса

Проект обеспечивает полный цикл работы с заказами пиццы от просмотра меню до оформления заказа, с поддержкой избранного и системой рекомендаций на основе популярности товаров.